<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metadata Scrubber</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        padding: 30px;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .upload-section,
      .logs-section,
      .downloads-section,
      .metadata-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        border: 2px dashed #dee2e6;
      }
      .upload-section{
        justify-contents: center
      }

      .logs-section,
      .downloads-section,
      .metadata-section {
        grid-column: 1 / -1;
      }

      h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      h3 {
        color: #34495e;
        margin: 15px 0 10px 0;
        font-size: 1.2em;
      }

      .upload-area {
        border: 3px dashed #3498db;
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        background: #ecf0f1;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .upload-area:hover {
        background: #d6dbdf;
        border-color: #2980b9;
      }

      .upload-area.highlight {
        background: #d5edda;
        border-color: #28a745;
      }

      .upload-icon {
        font-size: 3em;
        color: #3498db;
        margin-bottom: 15px;
      }

      .file-input {
        display: none;
      }

      .btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 10px 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }

      .btn-warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      }

      .status {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .logs-container {
        background: #2c3e50;
        color: #ecf0f1;
        border-radius: 8px;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #34495e;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .downloads-list {
        display: grid;
        gap: 10px;
      }

      .download-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .download-item:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .file-info {
        flex-grow: 1;
      }

      .file-name {
        font-weight: 600;
        color: #2c3e50;
      }

      .file-size {
        color: #7f8c8d;
        font-size: 0.9em;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #ecf0f1;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
        display: none;
      }

      .progress {
        height: 100%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      .refresh-btn {
        background: #95a5a6;
        margin-bottom: 15px;
      }

      .metadata-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .metadata-container {
          grid-template-columns: 1fr;
        }
      }

      .metadata-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #dee2e6;
        max-height: 500px;
        overflow-y: auto;
      }

      .metadata-panel h4 {
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
      }

      .metadata-original h4 {
        border-color: #e74c3c;
        color: #e74c3c;
      }

      .metadata-scrubbed h4 {
        border-color: #27ae60;
        color: #27ae60;
      }

      .metadata-content {
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        line-height: 1.4;
        white-space: pre-wrap;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
      }

      .metadata-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 40px 20px;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
      }

      .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: 600;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
      .metadata-section {
        grid-column: 1 / -1;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        border: 2px dashed #dee2e6;
      }

      .metadata-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .metadata-container {
          grid-template-columns: 1fr;
        }
      }

      .metadata-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #dee2e6;
        max-height: 500px;
        overflow-y: auto;
      }

      .metadata-panel h4 {
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
      }

      .metadata-original h4 {
        border-color: #e74c3c;
        color: #e74c3c;
      }

      .metadata-scrubbed h4 {
        border-color: #27ae60;
        color: #27ae60;
      }

      .metadata-content {
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        line-height: 1.4;
        white-space: pre-wrap;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
      }

      .metadata-placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 40px 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Metadata Scrubber</h1>
        <div class="subtitle">
          Upload files to remove sensitive metadata and download cleaned
          versions
        </div>
      </header>

      <div class="main-content">
        <div class="upload-section">
          <h2>Upload File</h2>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <h3>Drop your file here or click to browse</h3>
            <p>
              Supported formats: Images, PDFs, Office documents, Audio/Video
              files
            </p>
            <input type="file" id="fileInput" class="file-input" accept="*/*" />
            <button
              class="btn"
              onclick="document.getElementById('fileInput').click()"
            >
              Choose File
            </button>
          </div>
          <div class="progress-bar" id="progressBar">
            <div class="progress" id="progress"></div>
          </div>
          <div id="status"></div>
          <button
            class="btn btn-success"
            id="scrubBtn"
            onclick="scrubFile()"
            disabled
          >
            Scrub Metadata
          </button>
        </div>

        <div class="metadata-section">
          <h2>Metadata Analysis</h2>
          <div class="metadata-container">
            <div class="metadata-panel metadata-original">
              <h4>üìä Original Metadata</h4>
              <div class="metadata-content" id="originalMetadata">
                <div class="metadata-placeholder">
                  Upload and scrub a file to see metadata
                </div>
              </div>
            </div>
            <div class="metadata-panel metadata-scrubbed">
              <h4>‚úÖ Scrubbed Metadata</h4>
              <div class="metadata-content" id="scrubbedMetadata">
                <div class="metadata-placeholder">
                  Upload and scrub a file to see metadata
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="downloads-section">
          <h2>
            Available Downloads
            <button class="btn refresh-btn" onclick="loadDownloads()">
              Refresh
            </button>
          </h2>
          <div class="downloads-list" id="downloadsList">
            <div class="status info">No scrubbed files available yet</div>
          </div>
        </div>

        <div class="logs-section">
          <h2>
            Activity Logs
            <button class="btn refresh-btn" onclick="loadLogs()">
              Refresh
            </button>
          </h2>
          <div class="logs-container" id="logsContainer">
            <div class="log-entry">Logs will appear here...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let selectedFile = null;
      let currentMetadata = {
        original: '',
        scrubbed: '',
      };

      // Initialize drag and drop
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const scrubBtn = document.getElementById("scrubBtn");
      const progressBar = document.getElementById("progressBar");
      const progress = document.getElementById("progress");

      // Drag and drop handlers
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          () => uploadArea.classList.add("highlight"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          () => uploadArea.classList.remove("highlight"),
          false
        );
      });

      uploadArea.addEventListener("drop", handleDrop, false);
      fileInput.addEventListener("change", handleFileSelect, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      function handleFileSelect(e) {
        handleFiles(e.target.files);
      }

      function handleFiles(files) {
        if (files.length > 0) {
          selectedFile = files[0];
          updateFileSelection();
        }
      }

      function updateFileSelection() {
        if (selectedFile) {
          uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <h3>${selectedFile.name}</h3>
                    <p>Size: ${formatFileSize(selectedFile.size)}</p>
                    <button class="btn btn-danger" onclick="clearSelection()">Choose Different File</button>
                `;
          scrubBtn.disabled = false;
        }
      }

      function clearSelection() {
        selectedFile = null;
        fileInput.value = "";
        uploadArea.innerHTML = `
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your file here or click to browse</h3>
                <p>Supported formats: Images, PDFs, Office documents, Audio/Video files</p>
                <input type="file" id="fileInput" class="file-input" accept="*/*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
            `;
        scrubBtn.disabled = true;
        document.getElementById("status").innerHTML = "";

        // Clear metadata display
        currentMetadata = { original: "", scrubbed: "" };
        updateMetadataDisplay();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      async function scrubFile() {
        if (!selectedFile) return;

        const statusDiv = document.getElementById("status");
        progressBar.style.display = "block";
        progress.style.width = "0%";
        scrubBtn.disabled = true;

        try {
          const formData = new FormData();
          formData.append("file", selectedFile);

          // Simulate progress
          let progressValue = 0;
          const progressInterval = setInterval(() => {
            progressValue += Math.random() * 10;
            if (progressValue >= 90) {
              clearInterval(progressInterval);
            }
            progress.style.width = progressValue + "%";
          }, 200);

          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          clearInterval(progressInterval);
          progress.style.width = "100%";

          const result = await response.json();

          if (result.status === "success") {
            statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ ${result.message}<br>
                            Scrubbed file: ${result.scrubbed_file}
                        </div>
                    `;

            // Store and display metadata
            currentMetadata.original =
              result.original_metadata || "No metadata available";
            currentMetadata.scrubbed =
              result.scrubbed_metadata || "No metadata available";
            updateMetadataDisplay();

            // Auto-refresh downloads and logs
            loadDownloads();
            loadLogs();

            // Switch to comparison tab
            // showTab("comparison");
          } else {
            statusDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå ${result.message}
                        </div>
                    `;
          }
        } catch (error) {
          statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Upload failed: ${error.message}
                    </div>
                `;
        } finally {
          scrubBtn.disabled = false;
          setTimeout(() => {
            progressBar.style.display = "none";
          }, 1000);
        }
      }

   function updateMetadataDisplay() {
    document.getElementById('originalMetadata').textContent = currentMetadata.original || 'No metadata available';
    document.getElementById('scrubbedMetadata').textContent = currentMetadata.scrubbed || 'No metadata available';
}

// Update the scrubFile function - add these lines in the success section:
if (result.status === 'success') {
    statusDiv.innerHTML = `
        <div class="status success">
            ‚úÖ ${result.message}<br>
            Scrubbed file: ${result.scrubbed_file}
        </div>
    `;
    
    // ADD THESE LINES:
    currentMetadata.original = result.original_metadata || 'No metadata available';
    currentMetadata.scrubbed = result.scrubbed_metadata || 'No metadata available';
    updateMetadataDisplay();
    
    // Auto-refresh downloads and logs
    loadDownloads();
    loadLogs();
}
      // function showTab(tabName) {
      //     // Update tabs
      //     document.querySelectorAll('.tab').forEach(tab => {
      //         tab.classList.remove('active');
      //     });
      //     document.querySelectorAll('.tab-content').forEach(content => {
      //         content.classList.remove('active');
      //     });

      //     // Activate selected tab
      //     event.currentTarget.classList.add('active');
      //     document.getElementById(tabName).classList.add('active');
      // }

      async function loadDownloads() {
        try {
          const response = await fetch("/downloads");
          const downloads = await response.json();

          const downloadsList = document.getElementById("downloadsList");

          if (downloads.length === 0) {
            downloadsList.innerHTML =
              '<div class="status info">No scrubbed files available yet</div>';
            return;
          }

          downloadsList.innerHTML = downloads
            .map(
              (file) => `
                    <div class="download-item">
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(
                              file.size
                            )} ‚Ä¢ Modified: ${new Date(
                file.modified
              ).toLocaleString()}</div>
                        </div>
                        <div class="controls">
                            <button class="btn btn-warning" onclick="viewMetadata('${
                              file.name
                            }')">View Metadata</button>
                            <button class="btn btn-success" onclick="downloadFile('${
                              file.name
                            }')">Download</button>
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Failed to load downloads:", error);
        }
      }

      async function viewMetadata(filename) {
        try {
          const response = await fetch(`/metadata/${filename}`);
          const result = await response.json();

          currentMetadata.scrubbed = result.metadata || "No metadata available";
          updateMetadataDisplay();
        //   showTab("scrubbed");
        } catch (error) {
          console.error("Failed to load metadata:", error);
          alert("Failed to load metadata for file: " + filename);
        }
      }

      async function loadLogs() {
        try {
          const response = await fetch("/logs");
          const logs = await response.json();

          const logsContainer = document.getElementById("logsContainer");
          logsContainer.innerHTML = logs
            .map(
              (log) => `
                    <div class="log-entry">${log}</div>
                `
            )
            .join("");

          // Auto-scroll to bottom
          logsContainer.scrollTop = logsContainer.scrollHeight;
        } catch (error) {
          console.error("Failed to load logs:", error);
        }
      }

      function downloadFile(filename) {
        window.open(`/download/${filename}`, "_blank");
      }

      // Auto-refresh logs every 5 seconds
      setInterval(loadLogs, 5000);

      // Initial load
      loadDownloads();
      loadLogs();
    </script>
  </body>
</html>
